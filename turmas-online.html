<!DOCTYPE HTML>
<html lang="pt">
<head>
    <title>Turmas Online - TecDigital</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
</head>
<body class="is-preload">
    <div id="wrapper" class="fade-in">
        <header id="header"><a href="index.html" class="logo">TecDigital</a></header>
        <nav id="nav">
            <ul class="links">
                <li><a href="index.html">Home</a></li>
                <li class="active"><a href="turmas-online.html">Turmas Online</a></li>
                <li><a href="consulta.html">Consultar Inscrição</a></li>
                <li><a href="somostecdigital.html">Quem Somos</a></li>
            </ul>
        </nav>

        <div id="main">
            <article class="post featured">
                <header class="major">
                    <h2>Turmas Online Disponíveis</h2>
                    <p>Escolha a sua turma e comece a sua jornada de aprendizagem connosco.</p>
                </header>
                <section id="class-list" class="posts">
                    <p>A carregar turmas disponíveis...</p>
                </section>
            </article>
        </div>

        <footer id="footer"></footer>
        <div id="copyright"><ul><li>&copy; TecDigital Sul LDA</li></ul></div>
    </div>

    <div class="modal fade" id="onlineRegistrationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Inscrição</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#google-tab-pane" type="button">Login com Google (Rápido)</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="manual-tab-button" data-bs-toggle="tab" data-bs-target="#manual-tab-pane" type="button">Inscrição Manual</button></li>
                    </ul>
                    <div class="tab-content p-3 border border-top-0">
                        <div class="tab-pane fade show active" id="google-tab-pane">
                            <div id="g_id_onload" data-client_id="O_SEU_ID_DE_CLIENTE_VAI_AQUI" data-callback="handleCredentialResponse"></div>
                            <div class="g_id_signin" data-type="standard"></div>
                            <div id="google-status-message" class="mt-3 text-center"></div>
                        </div>
                        <div class="tab-pane fade" id="manual-tab-pane">
                            <div id="manual-form-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbxyHnW6rIT1lJ9dPBqnvKYZQ3KZ0IHZV_e_3g4dtgI98cyu8X7cbxrlOozF3o1srf8fyg/exec'; // URL da API PÚBLICA
        const modalElement = document.getElementById('onlineRegistrationModal');
        const onlineRegistrationModal = new bootstrap.Modal(modalElement);

        function openRegistrationModal(classId, className) {
            document.getElementById('modal-title').textContent = `Inscrição: ${className}`;
            modalElement.dataset.classId = classId;
            onlineRegistrationModal.show();
        }

        // Carrega o formulário manual dinamicamente
        document.getElementById('manual-tab-button').addEventListener('click', () => {
            const container = document.getElementById('manual-form-container');
            if (container.innerHTML === '') {
                container.innerHTML = 'A carregar formulário...';
                fetch('ins-curso/inscricao.html')
                    .then(res => res.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const form = doc.querySelector('form');
                        const scriptContent = doc.querySelector('script').innerHTML;
                        container.innerHTML = '';
                        container.appendChild(form);
                        const newScript = document.createElement('script');
                        newScript.innerHTML = scriptContent;
                        document.body.appendChild(newScript);
                    });
            }
        });
        
        // Lógica do Login com Google
        async function handleCredentialResponse(response) {
            const statusDiv = document.getElementById('google-status-message');
            statusDiv.innerHTML = 'A processar...';
            const decodedToken = JSON.parse(atob(response.credential.split('.')[1]));
            const payload = {
                action: 'registerOnlineStudent',
                payload: {
                    classId: modalElement.dataset.classId,
                    studentInfo: { email: decodedToken.email, name: decodedToken.name, given_name: decodedToken.given_name, family_name: decodedToken.family_name }
                }
            };
            try {
                const res = await fetch(webAppUrl, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' }, mode: 'cors' });
                const result = await res.json();
                if (result.status === 'success') {
                    statusDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                    setTimeout(() => onlineRegistrationModal.hide(), 4000);
                } else { throw new Error(result.message); }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }
        
        // Lógica para carregar a lista de turmas (igual à anterior)
        document.addEventListener('DOMContentLoaded', async function() {
            const classListContainer = document.getElementById('class-list');
            try {
                const response = await fetch(`${webAppUrl}?action=getOnlineClasses`);
                const result = await response.json();
                if (result.status === 'success' && result.data.length > 0) {
                    classListContainer.innerHTML = '';
                    result.data.forEach(turma => {
                        const article = document.createElement('article');
                        article.innerHTML = `
                            <header><span class="date">${turma.course}</span><h2><a href="#">${turma.name}</a></h2></header>
                            <a href="#" class="image fit"><img src="images/pic02.jpg" alt="" /></a>
                            <p>Inscrições abertas para esta turma online. Vagas limitadas.</p>
                            <ul class="actions special">
                                <li><button class="button" onclick="openRegistrationModal('${turma.id}', '${turma.name}')">Inscrever-me</button></li>
                            </ul>`;
                        classListContainer.appendChild(article);
                    });
                } else {
                     classListContainer.innerHTML = '<p>De momento, não há turmas online com inscrições abertas.</p>';
                }
            } catch (error) {
                classListContainer.innerHTML = `<p style="color: red;"><strong>Erro:</strong> Não foi possível carregar a lista de turmas.</p>`;
            }
        });
    </script>
</body>
</html>